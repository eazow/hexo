---
title: ç¼–è¯‘Linuxå†…æ ¸å¢åŠ ç³»ç»Ÿè°ƒç”¨
date: 2008-02-29 18:50:36
tags: Linux
categories: Linux
---

> **å®éªŒç¯å¢ƒ**ï¼šUbuntu 7.10 + Linux Kernel 2.6.23.12  
> **è€—æ—¶**ï¼šçº¦ 2-3 å°æ—¶ï¼ˆä¸»è¦æ˜¯ç¼–è¯‘æ—¶é—´ï¼‰  
> **éš¾åº¦**ï¼šâ­â­â­

ç»è¿‡ä¸€ä¸¤å¤©çš„æ‘¸ç´¢ï¼Œç»ˆäºåœ¨ Ubuntu è™šæ‹Ÿæœºä¸­æˆåŠŸå®Œæˆäº†å†…æ ¸ç¼–è¯‘å’Œç³»ç»Ÿè°ƒç”¨æ·»åŠ å®éªŒã€‚æœŸé—´è¸©äº†ä¸å°‘å‘ï¼Œæ¢äº†å‡ ä¸ªå†…æ ¸ç‰ˆæœ¬ï¼Œé‡æ–°ç¼–è¯‘äº†å¤šæ¬¡ã€‚ç°å°†å®Œæ•´æ­¥éª¤æ•´ç†å¦‚ä¸‹ï¼Œå¸Œæœ›èƒ½æœ‰æ‰€å¸®åŠ©ï¼



## ğŸ“‹ å‡†å¤‡å·¥ä½œ

### ç³»ç»Ÿè¦æ±‚
- Ubuntu 7.10 æˆ–æ›´é«˜ç‰ˆæœ¬
- è‡³å°‘ 20GB ç£ç›˜ç©ºé—´
- 4GB ä»¥ä¸Šå†…å­˜ï¼ˆè™šæ‹Ÿæœºå»ºè®®åˆ†é… 2GB+ï¼‰

### ä¸‹è½½å†…æ ¸æºç 
è®¿é—® [https://www.kernel.org](https://www.kernel.org) ä¸‹è½½ Linux å†…æ ¸æºç åŒ…ï¼ˆæœ¬æ–‡ä½¿ç”¨ `linux-2.6.23.12.tar.gz`ï¼‰



## ğŸ”§ è¯¦ç»†æ­¥éª¤

### 1. è§£å‹å†…æ ¸æºç 

å°†å†…æ ¸åŒ…è§£å‹åˆ° `/usr/src` ç›®å½•ï¼š

```bash
cd /usr/src
sudo tar jxvf linux-2.6.23.12.tar.bz2
# æˆ–è€…å¦‚æœæ˜¯ .tar.gz æ ¼å¼
sudo tar zxvf linux-2.6.23.12.tar.gz
```



### 2. æ·»åŠ è‡ªå®šä¹‰ç³»ç»Ÿè°ƒç”¨

#### 2.1 ä¿®æ”¹ `sys.c` æ–‡ä»¶

åœ¨å†…æ ¸æºç ä¸­æ·»åŠ ç³»ç»Ÿè°ƒç”¨å®ç°ï¼š

```bash
cd /usr/src/linux-2.6.23.12
sudo vim kernel/sys.c
```

åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```c
/* è‡ªå®šä¹‰ç³»ç»Ÿè°ƒç”¨ï¼šæ‰“å°æ¶ˆæ¯å¹¶è¿”å›å‚æ•° */
asmlinkage int sys_mysyscall(int num) {
    printk(KERN_INFO "Hello from mysyscall! Received: %d\n", num);
    return num;
}
```

> **æ³¨æ„**ï¼š`asmlinkage` æ˜¯å¿…éœ€çš„ï¼Œè¡¨ç¤ºå‚æ•°é€šè¿‡æ ˆä¼ é€’ã€‚



#### 2.2 ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨

ç¼–è¾‘ç³»ç»Ÿè°ƒç”¨è¡¨æ–‡ä»¶ï¼š

```bash
cd /usr/src/linux-2.6.23.12/arch/i386/kernel
# å¦‚æœæ²¡æœ‰ i386 ç›®å½•ï¼Œå°è¯• x86 ç›®å½•
sudo vim syscall_table.S
```

åœ¨æ–‡ä»¶**æœ«å°¾**æ·»åŠ ï¼š

```assembly
.long sys_mysyscall
```



#### 2.3 æ·»åŠ ç³»ç»Ÿè°ƒç”¨å·

**ä¿®æ”¹ç³»ç»Ÿå¤´æ–‡ä»¶**ï¼ˆç”¨æˆ·ç©ºé—´ï¼‰ï¼š

```bash
sudo vim /usr/include/asm-i386/unistd.h
```

åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š

```c
#define __NR_mysyscall 325
```

**ä¿®æ”¹å†…æ ¸å¤´æ–‡ä»¶**ï¼š

```bash
sudo vim /usr/src/linux-2.6.23.12/include/asm-i386/unistd.h
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```c
#define __NR_mysyscall 325
```

åŒæ—¶å°†åŸæœ‰çš„ï¼š

```c
#define NR_syscalls 325
```

ä¿®æ”¹ä¸ºï¼š

```c
#define NR_syscalls 326
```

> **æç¤º**ï¼šå¦‚æœè¦æ·»åŠ å¤šä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¾æ¬¡é€’å¢è°ƒç”¨å·ï¼ˆ326, 327...ï¼‰



### 3. ç¼–è¯‘å†…æ ¸

#### 3.1 é…ç½®å†…æ ¸

```bash
cd /usr/src/linux-2.6.23.12
sudo make menuconfig
```

åœ¨èœå•ä¸­ä¿æŒé»˜è®¤é…ç½®å³å¯ï¼Œç›´æ¥ä¿å­˜é€€å‡ºã€‚



#### 3.2 ç¼–è¯‘å†…æ ¸é•œåƒ

```bash
sudo make bzImage
```

> **è€—æ—¶**ï¼šçº¦ 30-60 åˆ†é’Ÿ



#### 3.3 ç¼–è¯‘å†…æ ¸æ¨¡å—

```bash
sudo make modules
```

> **è€—æ—¶**ï¼šçº¦ 1-2 å°æ—¶ï¼ˆè™šæ‹Ÿæœºä¼šæ›´æ…¢ï¼‰  
> **å»ºè®®**ï¼šæ­¤æ—¶å¯ä»¥ä¼‘æ¯ä¸€ä¸‹ï¼Œå–æ¯å’–å•¡æˆ–æ‰“æ‰“çƒ ğŸ˜Š



#### 3.4 å®‰è£…æ¨¡å—

```bash
sudo make modules_install
```

æ‰§è¡Œåä¼šåœ¨ `/lib/modules/` ä¸‹ç”Ÿæˆ `2.6.23.12` ç›®å½•ã€‚



#### 3.5 å®‰è£…å†…æ ¸

```bash
# å¤åˆ¶å†…æ ¸é•œåƒ
sudo cp arch/i386/boot/bzImage /boot/vmlinuz-2.6.23.12

# ç”Ÿæˆ initramfs
sudo mkinitramfs -o /boot/initrd.img-2.6.23.12 2.6.23.12
```



### 4. é…ç½® GRUB å¼•å¯¼

#### 4.1 ç¼–è¾‘ GRUB é…ç½®æ–‡ä»¶

```bash
sudo vim /boot/grub/menu.lst
# æˆ–è€…
sudo vim /boot/grub/grub.conf
```



#### 4.2 æ·»åŠ æ–°å†…æ ¸å¯åŠ¨é¡¹

åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°ç±»ä¼¼ä»¥ä¸‹çš„é…ç½®ï¼š

```
title Ubuntu 7.10, kernel 2.6.22-14-generic
root (hd0,0)
kernel /boot/vmlinuz-2.6.22-14-generic root=UUID=e2478f9d-7f5d-458f-b017-43458a8f62ea ro quiet splash
initrd /boot/initrd.img-2.6.22-14-generic
quiet
```

ä»¿ç…§æ ¼å¼æ·»åŠ æ–°å†…æ ¸é…ç½®ï¼š

```
title Ubuntu 7.10, kernel 2.6.23.12 (Custom)
root (hd0,0)
kernel /boot/vmlinuz-2.6.23.12 root=UUID=e2478f9d-7f5d-458f-b017-43458a8f62ea ro quiet splash
initrd /boot/initrd.img-2.6.23.12
quiet
```

> **æ³¨æ„**ï¼š`UUID` éœ€è¦æ›¿æ¢ä¸ºä½ è‡ªå·±çš„åˆ†åŒº UUIDï¼Œå¯é€šè¿‡ `sudo blkid` æŸ¥çœ‹ã€‚



#### 4.3 æ˜¾ç¤º GRUB èœå•

æ³¨é‡Šæ‰éšè—èœå•é€‰é¡¹ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š

```
#hiddenmenu
```

ä¿å­˜å¹¶é€€å‡ºã€‚



### 5. é‡å¯ç³»ç»Ÿ

```bash
sudo reboot
```

åœ¨ GRUB å¯åŠ¨èœå•ä¸­é€‰æ‹©æ–°ç¼–è¯‘çš„å†…æ ¸ `kernel 2.6.23.12 (Custom)` å¯åŠ¨ã€‚



## ğŸ§ª æµ‹è¯•è‡ªå®šä¹‰ç³»ç»Ÿè°ƒç”¨

### ç¼–å†™æµ‹è¯•ç¨‹åº

åˆ›å»º `test.c` æ–‡ä»¶ï¼š

```c
#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>

#define __NR_mysyscall 325

int main() {
    int result;
    
    printf("è°ƒç”¨è‡ªå®šä¹‰ç³»ç»Ÿè°ƒç”¨ mysyscall...\n");
    result = syscall(__NR_mysyscall, 42);
    
    printf("ç³»ç»Ÿè°ƒç”¨è¿”å›å€¼: %d\n", result);
    
    return 0;
}
```



### ç¼–è¯‘å¹¶è¿è¡Œ

```bash
gcc -o test test.c
./test
```

**é¢„æœŸè¾“å‡º**ï¼š

```
è°ƒç”¨è‡ªå®šä¹‰ç³»ç»Ÿè°ƒç”¨ mysyscall...
ç³»ç»Ÿè°ƒç”¨è¿”å›å€¼: 42
```



### æŸ¥çœ‹å†…æ ¸æ—¥å¿—

```bash
dmesg | tail
```

åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```
[12345.678901] Hello from mysyscall! Received: 42
```



## å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šæ‰¾ä¸åˆ° `i386` ç›®å½•

**è§£å†³æ–¹æ¡ˆ**ï¼šæ–°ç‰ˆæœ¬å†…æ ¸å¯èƒ½ä½¿ç”¨ `x86` ç›®å½•ï¼Œä¿®æ”¹è·¯å¾„ä¸ºï¼š

```bash
cd /usr/src/linux-2.6.23.12/arch/x86/kernel
```



### é—®é¢˜ 2ï¼š`make modules` éå¸¸æ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨å¤šæ ¸ç¼–è¯‘ï¼š`sudo make -j4 modules`ï¼ˆ4 ä¸º CPU æ ¸å¿ƒæ•°ï¼‰
- è™šæ‹Ÿæœºåˆ†é…æ›´å¤š CPU å’Œå†…å­˜



### é—®é¢˜ 3ï¼šç¼–è¯‘æŠ¥é”™ç¼ºå°‘ä¾èµ–

**è§£å†³æ–¹æ¡ˆ**ï¼šå®‰è£…å¿…è¦çš„ç¼–è¯‘å·¥å…·ï¼š

```bash
sudo apt-get update
sudo apt-get install build-essential libncurses5-dev
```



### é—®é¢˜ 4ï¼šç³»ç»Ÿè°ƒç”¨è¿”å› -1

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨å·æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ `NR_syscalls` å·²æ›´æ–°
- æŸ¥çœ‹ `dmesg` è¾“å‡ºæ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯



## âœ… æ€»ç»“ä¸å»ºè®®

### å…³é”®è¦ç‚¹

1. **è€å¿ƒ**ï¼šå†…æ ¸ç¼–è¯‘è€—æ—¶è¾ƒé•¿ï¼Œå°¤å…¶æ˜¯ `make modules`
2. **å¤‡ä»½**ï¼šä¿®æ”¹å‰å¤‡ä»½é‡è¦æ–‡ä»¶
3. **ç‰ˆæœ¬åŒ¹é…**ï¼šç¡®ä¿å†…æ ¸ç‰ˆæœ¬ä¸æ•™ç¨‹ä¸€è‡´
4. **æ—¥å¿—æŸ¥çœ‹**ï¼šå–„ç”¨ `dmesg` è°ƒè¯•

### å­¦ä¹ æ”¶è·

- ç†è§£ Linux å†…æ ¸ç¼–è¯‘æµç¨‹
- æŒæ¡ç³»ç»Ÿè°ƒç”¨æ·»åŠ æ–¹æ³•
- ç†Ÿæ‚‰å†…æ ¸æ¨¡å—æœºåˆ¶
- æå‡ Linux ç³»ç»Ÿåº•å±‚è®¤çŸ¥



## ğŸ“š å‚è€ƒèµ„æ–™

- [Linux Kernel Archives](https://www.kernel.org)
- [The Linux Kernel Documentation](https://www.kernel.org/doc/html/latest/)
- [Linux System Call Table](https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md)



**ç¥å„ä½å®éªŒé¡ºåˆ©ï¼å¦‚æœ‰é—®é¢˜æ¬¢è¿äº¤æµè®¨è®ºï¼** ğŸ‰